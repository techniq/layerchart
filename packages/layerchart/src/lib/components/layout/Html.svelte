<script lang="ts" module>
  import type { HTMLAttributes } from 'svelte/elements';
  import type { Without } from '$lib/utils/types.js';
  import type { Snippet } from 'svelte';

  type HTMLPropsWithoutHTML = {
    /**
     * A reference to the layer's outermost `<div>` tag.
     *
     * @bindable
     */
    ref?: HTMLElement;

    /**
     * The layer's z-index.
     */
    zIndex?: number;

    /**
     * Set this to `false` to set `pointer-events: none;` on the entire layer.
     */
    pointerEvents?: boolean;

    /**
     * A string passed to the `aria-role` on the `<div>` tag.
     * This is `undefined` by default but will be set by default to `'figure'`
     * if `label`, `labelledby` or `describedby` is set. That default will be overridden by whatever is passed in.
     */
    role?: string;

    /**
     * Translate children to center (useful for radial layouts)
     */
    center?: boolean | 'x' | 'y';

    /**
     * Ignore TransformContext.  Useful to add static elements such as legends.
     */
    ignoreTransform?: boolean;

    children?: Snippet<[{ ref: HTMLElement }]>;
  };

  export type HTMLProps = HTMLPropsWithoutHTML &
    Without<HTMLAttributes<HTMLElement>, HTMLPropsWithoutHTML>;
</script>

<script lang="ts">
  import { cls } from '@layerstack/tailwind';
  import { getTransformContext } from '../TransformContext.svelte';

  import { getChartContext, setRenderContext } from '../Chart.svelte';
  import { extractLayerProps } from 'layerchart/utils/attributes.js';

  let {
    ref = $bindable(),
    zIndex = 0,
    pointerEvents = true,
    role,
    'aria-label': label,
    'aria-labelledby': labelledBy,
    'aria-describedby': describedBy,
    center = false,
    ignoreTransform = false,
    class: className,
    children,
    ...restProps
  }: HTMLProps = $props();

  const roleVal = $derived(role || (label || labelledBy || describedBy ? 'figure' : undefined));

  const ctx = getChartContext();
  const transformCtx = getTransformContext();

  const transform = $derived.by(() => {
    if (transformCtx.mode === 'canvas' && !ignoreTransform) {
      return `translate(${transformCtx.translate.x}px,${transformCtx.translate.y}px) scale(${transformCtx.scale})`;
    } else if (center) {
      return `translate(${center === 'x' || center === true ? ctx.width / 2 : 0}px, ${center === 'y' || center === true ? ctx.height / 2 : 0}px)`;
    }
  });

  setRenderContext('html');
</script>

<div
  bind:this={ref}
  class={cls('absolute top-0 left-0', pointerEvents === false && 'pointer-events-none', className)}
  style:transform
  style:transform-origin="top left"
  style:z-index={zIndex}
  style:pointer-events={pointerEvents === false ? 'none' : null}
  style:top="{ctx.padding.top}px"
  style:bottom="{ctx.padding.bottom}px"
  style:left="{ctx.padding.left}px"
  style:right="{ctx.padding.right}px"
  role={roleVal}
  aria-label={label}
  aria-labelledby={labelledBy}
  aria-describedby={describedBy}
  {...extractLayerProps(restProps, 'layout-html')}
>
  {@render children?.({ ref })}
</div>
