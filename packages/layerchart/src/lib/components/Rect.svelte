<script lang="ts">
  import { onDestroy, tick } from 'svelte';
  import { cls } from '@layerstack/tailwind';
  import { objectId } from '@layerstack/utils/object';

  import {
    motionStore,
    resolveOptions,
    type SpringOptions,
    type TweenedOptions,
  } from '$lib/stores/motionStore.js';
  import { getCanvasContext } from './layout/Canvas.svelte';
  import { renderRect } from '../utils/canvas.js';

  export let x = 0;
  export let initialX = x;

  export let y = 0;
  export let initialY = y;

  export let width: number;
  export let initialWidth = width;

  export let height: number;
  export let initialHeight = height;

  export let fill: string | undefined = undefined;
  export let fillOpacity: number | undefined = undefined;
  export let stroke: string | undefined = undefined;
  export let strokeWidth: number | undefined = undefined;

  let className: string | undefined = undefined;
  export { className as class };

  export let spring: boolean | SpringOptions | { [prop: string]: SpringOptions } = undefined;
  export let tweened: boolean | TweenedOptions | { [prop: string]: TweenedOptions } = undefined;

  let tweened_x = motionStore(initialX, resolveOptions('x', { spring, tweened }));
  let tweened_y = motionStore(initialY, resolveOptions('y', { spring, tweened }));
  let tweened_width = motionStore(initialWidth, resolveOptions('width', { spring, tweened }));
  let tweened_height = motionStore(initialHeight, resolveOptions('height', { spring, tweened }));

  $: tick().then(() => {
    tweened_x.set(x);
    tweened_y.set(y);
    tweened_width.set(width);
    tweened_height.set(height);
  });

  const canvasContext = getCanvasContext();
  const renderContext = canvasContext ? 'canvas' : 'svg';

  function render(ctx: CanvasRenderingContext2D) {
    renderRect(
      ctx,
      { x: $tweened_x, y: $tweened_y, width: $tweened_width, height: $tweened_height },
      {
        styles: { fill, fillOpacity, stroke, strokeWidth },
        classes: className,
      }
    );
  }

  // TODO: Use objectId to work around Svelte 4 reactivity issue (even when memoizing gradients)
  $: fillKey = typeof fill === 'object' ? objectId(fill) : fill;
  $: strokeKey = typeof stroke === 'object' ? objectId(stroke) : stroke;

  $: if (renderContext === 'canvas') {
    // Redraw when props change
    $tweened_x &&
      $tweened_y &&
      $tweened_width &&
      $tweened_height &&
      fillKey &&
      strokeKey &&
      strokeWidth &&
      className;
    canvasContext.invalidate();
  }

  let canvasUnregister: ReturnType<typeof canvasContext.register>;
  $: if (renderContext === 'canvas') {
    canvasUnregister = canvasContext.register({ name: 'Rect', render });
  }

  onDestroy(() => {
    if (renderContext === 'canvas') {
      canvasUnregister();
    }
  });
</script>

{#if renderContext === 'svg'}
  <!-- svelte-ignore a11y-mouse-events-have-key-events -->
  <!-- svelte-ignore a11y-no-static-element-interactions -->
  <rect
    x={$tweened_x}
    y={$tweened_y}
    width={$tweened_width}
    height={$tweened_height}
    class={cls(fill == null && 'fill-surface-content')}
    {fill}
    fill-opacity={fillOpacity}
    {stroke}
    stroke-width={strokeWidth}
    {...$$restProps}
    on:click
    on:pointerenter
    on:pointerover
    on:pointermove
    on:pointerout
    on:pointerleave
    on:dblclick
  />
{/if}
