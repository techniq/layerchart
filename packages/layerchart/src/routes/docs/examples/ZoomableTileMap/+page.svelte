<script lang="ts">
  import { cubicOut } from 'svelte/easing';
  import { geoMercator, geoBounds } from 'd3-geo';
  import { feature } from 'topojson-client';

  import { Field, RangeField, Switch, ToggleGroup, ToggleOption } from 'svelte-ux';

  import GeoDebug from '$lib/docs/GeoDebug.svelte';
  import Preview from '$lib/docs/Preview.svelte';
  import TilesetField from '$lib/docs/TilesetField.svelte';
  import TransformControls from '$lib/docs/TransformControls.svelte';

  import Chart, { Svg } from '$lib/components/Chart.svelte';
  import GeoPath from '$lib/components/GeoPath.svelte';
  import GeoTile from '$lib/components/GeoTile.svelte';
  import Tooltip from '$lib/components/Tooltip.svelte';
  import TooltipItem from '$lib/components/TooltipItem.svelte';

  export let data;
  const states = feature(data.geojson, data.geojson.objects.states);

  $: filteredStates = {
    ...states,
    features: states.features.filter(
      (d) => d.properties.name !== 'Alaska' && d.properties.name !== 'Hawaii'
    ),
  };
  // $: filteredStates = { ...states, features: states.features.filter(d => d.properties.name === 'West Virginia')}
  $: selectedFeature = filteredStates;

  let selectedStateName = null;
  let serviceUrl;
  let zoomDelta = 0;
  let transform: Transform;
  let scrollMode = 'scale';
  let debug = false;

  // Needed for initial transform context
  const initialScale = geoMercator().scale();
  const initialTranslate = geoMercator().translate();
</script>

<div class="grid grid-cols-[1fr,1fr,1fr,auto] gap-2 my-2">
  <TilesetField bind:serviceUrl />
  <RangeField label="Zoom delta" bind:value={zoomDelta} min={-5} max={5} />
  <Field label="Scroll mode" let:id>
    <ToggleGroup bind:value={scrollMode} variant="outline" size="sm" inset class="w-full">
      <ToggleOption value="none">None</ToggleOption>
      <ToggleOption value="scale">Scale</ToggleOption>
      <ToggleOption value="translate">Translate</ToggleOption>
    </ToggleGroup>
  </Field>
  <Field label="Debug" let:id>
    <Switch bind:checked={debug} {id} />
  </Field>
</div>

<h1>Examples</h1>

<h2>SVG</h2>

<Preview data={filteredStates}>
  <div class="h-[600px] relative overflow-hidden">
    <TransformControls {transform} />
    <Chart
      geo={{
        projection: geoMercator,
        _fitGeojson: selectedFeature,
        applyTransform: ['translate', 'scale'],
      }}
      transform={{
        initialScale,
        initialTranslate: { x: initialTranslate[0], y: initialTranslate[1] },
        translateOnScale: true,
        scroll: scrollMode,
        tweened: { duration: 800, easing: cubicOut },
      }}
      tooltip={{ mode: 'manual' }}
      let:tooltip
      let:projection
    >
      {#if debug}
        <GeoDebug class="absolute top-0 left-0 z-10" />
      {/if}
      <Svg>
        <GeoTile url={serviceUrl} {zoomDelta} {debug} />
        {#each filteredStates.features as feature}
          <GeoPath
            geojson={feature}
            class="stroke-none"
            {tooltip}
            on:click={(e) => {
              const { geoPath, event } = e.detail;
              console.log({ selectedStateName, feature });
              /*
								if (selectedStateName === feature.properties.name) {
									selectedStateName = null;
									resetZoom();
								} else {
								*/
              selectedStateName = feature.properties.name;
              // let [[left, top], [right, bottom]] = geoPath.bounds(feature);
              console.log(geoPath.bounds(feature));
              let [minLongLat, maxLongLat] = geoBounds(feature);
              // Convert lat/long to screen x/y
              const [left, top] = projection(minLongLat);
              const [right, bottom] = projection(maxLongLat);
              let width = right - left;
              let height = bottom - top;
              //let x = (left + right) / 2;
              //let y = (top + bottom) / 2;
              let x = (left + right) / 2 + projection.translate()[0];
              let y = (top + bottom) / 2 + projection.translate()[1];
              const padding = 20;
              //zoomTo({ x, y }, { width: width + padding, height: height + padding })
              //}
            }}
          />
        {/each}
      </Svg>
      <Tooltip header={(data) => data.properties.name} let:data>
        {@const [longitude, latitude] = projection.invert([tooltip.x, tooltip.y])}
        <TooltipItem label="longitude" value={longitude} format="decimal" />
        <TooltipItem label="latitude" value={latitude} format="decimal" />
      </Tooltip>
    </Chart>
  </div>
</Preview>
